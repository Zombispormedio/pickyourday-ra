var app=angular.module("ar-toolkit",["ionic"]);angular.module("ar-toolkit").run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("ar-toolkit").directive("arView",["ARUtils","ARCamera","AR","$ionicPlatform",function(e,t,r,n){return{restrict:"A",link:function(o,a,i){var c=a[0];n.ready(function(){e.size(c),e.setVideoSize(),t.wait(function(){r.init(c),r.tick()})})}}}]),angular.module("ar-toolkit").factory("AR3D",function(){var e=function(e){function t(){a.needsUpdate=!0}var r=new THREE.Camera,n=new THREE.Scene,o=new THREE.PlaneGeometry(2,2,0),a=new THREE.Texture(e);a.generateMipmaps=!1,a.minFilter=THREE.NearestFilter,a.magFilter=THREE.NearestFilter,a.wrapS=a.wrapT=THREE.ClampToEdgeWrapping;var i=new THREE.MeshBasicMaterial({map:a,depthTest:!1,depthWrite:!1}),c=new THREE.Mesh(o,i);return n.add(c),{camera:r,scene:n,update:t}},t=function(){function e(e){r.add(e)}function t(e){r.remove(e)}var r=new THREE.Scene,n=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);return{scene:r,camera:n,add:e,remove:t}},r=function(r,n,o){function a(){d.render(l.scene,l.camera),d.render(m.scene,m.camera)}function i(){l.update()}function c(e){m.add(e.model)}function u(e){m.remove(e.model)}var d=new THREE.WebGLRenderer({canvas:r});d.setSize(n.width,n.height),d.autoClear=!1;var l=new e(o),m=new t,s=new THREE.SpotLight(16777215);return s.position.set(0,0,9e3),s.lookAt(new THREE.Vector3(0,0,0)),m.scene.add(s),{add:c,remove:u,update:i,render:a,glCanvas:r}};return{create:r}}),angular.module("ar-toolkit").factory("ARCamera",["ARUtils","$ionicPlatform",function(e,t){var r=document.getElementById("video"),n=function(e,t,r){var n=void 0;return navigator.getUserMedia?n=navigator.getUserMedia(e,t,r):navigator.webkitGetUserMedia&&(n=navigator.webkitGetUserMedia(e,t,r)),n},o=function(e){return function(t){var n=window.URL||window.webkitURL;r.src=n.createObjectURL(t),r.play(),e()}},a=function(e){console.log("An error occured! "+e)},i=function(e){n({video:!0,audio:!1},o(e),a)},c=function(){return{width:r.width,height:r.height}},u=function(e){e.drawImage(r,0,0)};return{wait:i,copyToContext:u,getDimensions:c}}]),angular.module("ar-toolkit").factory("ARDetector",function(){function e(e){var t=new NyARRgbRaster_Canvas2D(e),r=new FLARParam(e.width,e.height),n=new FLARMultiIdMarkerDetector(r,120);n.setContinueMode(!0);var o=function(e){var t=n.getIdMarkerData(e);if(t.packetLength>4)return-1;for(var r=0,o=0;o<t.packetLength;o++)r=r<<8|t.getPacketData(o);return r},a=function(e){var t=new NyARTransMatResult;n.getTransformMatrix(e,t);var r=new Float32Array(16);return r[0]=t.m00,r[1]=-t.m10,r[2]=t.m20,r[3]=0,r[4]=t.m01,r[5]=-t.m11,r[6]=t.m21,r[7]=0,r[8]=-t.m02,r[9]=t.m12,r[10]=-t.m22,r[11]=0,r[12]=t.m03,r[13]=-t.m13,r[14]=t.m23,r[15]=1,r},i=function(e,t){var n=new Float32Array(16);return r.copyCameraMatrix(n,e,t),n},c=1,u=function(e,t){return{id:e,matrix:t,age:c}},d={},l=function(e,r,i){for(var l=n.detectMarkerLite(t,70),m=0;l>m;m++){var s=o(m),f=d[s];void 0===f?(f=u(s,a(m)),d[s]=f,e(f)):(f.matrix=a(m),f.age=c,r(f))}for(var s in d){var f=d[s];f&&0==f.age--&&(i(f),delete d[s])}};return{detect:l,getCameraMatrix:i}}return{create:e}}),angular.module("ar-toolkit").factory("AR",["ARCamera","ARDetector","AR3D","ARMarker",function(e,t,r,n){var o,a,i,c,u=function(n){o=document.createElement("canvas");var u=e.getDimensions();o.width=u.width,o.height=u.height,a=o.getContext("2d"),i=t.create(o),c=r.create(n,u,o),console.log(i.getCameraMatrix(10,1e3))},d=function(){e.copyToContext(a),o.changed=!0,i.detect(n.onCreate(c),n.onUpdate(c),n.onDestroy(c)),c.update(),c.render(),window.requestAnimationFrame(d)};return{init:u,tick:d}}]),angular.module("ar-toolkit").factory("ARMarker",["ARObject",function(e){var t={16:e.create({color:13369344}),32:e.create({color:52224}),64:e.create({color:204})},r=function(e){return function(r){console.log("Created"),console.log(r.id);var n=t[r.id];console.log(n);var o=n.model;o.rotation.x+=.1,o.rotation.y+=.1,e.add(n)}},n=function(e){return function(e){console.log("update"),console.log(e.id);var r=t[e.id],n=r.model;n.rotation.x+=.1,n.rotation.y+=.1}},o=function(e){return function(r){console.log("remove"),console.log(r.id);var n=t[r.id];e.remove(n)}};return{onCreate:r,onUpdate:n,onDestroy:o}}]),angular.module("ar-toolkit").factory("ARObject",function(){function e(e){var t=new THREE.BoxGeometry(1,1,1),r=new THREE.MeshBasicMaterial({color:e}),n=new THREE.Mesh(t,r);return n.position.z=-5,n}function t(t){var r=e(t.color);return{model:r}}return{create:t}}),angular.module("ar-toolkit").factory("ARUtils",["$ionicPlatform",function(e){var t=function(e){e.width=window.innerWidth,e.height=window.innerHeight};return{size:t,setVideoSize:function(){t(document.getElementById("video"))}}}]);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbmZpZy9ib290LmpzIiwiY29tcG9uZW50cy9kaXJlY3RpdmVzL2FyX3ZpZXdfZGlyZWN0aXZlLmpzIiwiY29tcG9uZW50cy9mYWN0b3JpZXMvYXJfM2RfZmFjdG9yeS5qcyIsImNvbXBvbmVudHMvZmFjdG9yaWVzL2FyX2NhbWVyYV9mYWN0b3J5LmpzIiwiY29tcG9uZW50cy9mYWN0b3JpZXMvYXJfZGV0ZWN0b3JfZmFjdG9yeS5qcyIsImNvbXBvbmVudHMvZmFjdG9yaWVzL2FyX2ZhY3RvcnkuanMiLCJjb21wb25lbnRzL2ZhY3Rvcmllcy9hcl9tYXJrZXJfZmFjdG9yeS5qcyIsImNvbXBvbmVudHMvZmFjdG9yaWVzL2FyX29iamVjdF9mYWN0b3J5LmpzIiwiY29tcG9uZW50cy9mYWN0b3JpZXMvYXJfdXRpbHNfZmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJhcHAiLCJhbmd1bGFyIiwibW9kdWxlIiwicnVuIiwiJGlvbmljUGxhdGZvcm0iLCJyZWFkeSIsIndpbmRvdyIsImNvcmRvdmEiLCJwbHVnaW5zIiwiS2V5Ym9hcmQiLCJoaWRlS2V5Ym9hcmRBY2Nlc3NvcnlCYXIiLCJkaXNhYmxlU2Nyb2xsIiwiU3RhdHVzQmFyIiwic3R5bGVEZWZhdWx0IiwiZGlyZWN0aXZlIiwiQVJVdGlscyIsIkFSQ2FtZXJhIiwiQVIiLCJyZXN0cmljdCIsImxpbmsiLCJzY29wZSIsInRFbGVtZW50IiwiYXR0cnMiLCJlbGVtIiwic2l6ZSIsInNldFZpZGVvU2l6ZSIsIndhaXQiLCJpbml0IiwidGljayIsImZhY3RvcnkiLCJSZWFsaXR5Iiwic291cmNlQ2FudmFzIiwidXBkYXRlIiwidGV4dHVyZSIsIm5lZWRzVXBkYXRlIiwiY2FtZXJhIiwiVEhSRUUiLCJDYW1lcmEiLCJzY2VuZSIsIlNjZW5lIiwiZ2VvbWV0cnkiLCJQbGFuZUdlb21ldHJ5IiwiVGV4dHVyZSIsImdlbmVyYXRlTWlwbWFwcyIsIm1pbkZpbHRlciIsIk5lYXJlc3RGaWx0ZXIiLCJtYWdGaWx0ZXIiLCJ3cmFwUyIsIndyYXBUIiwiQ2xhbXBUb0VkZ2VXcmFwcGluZyIsIm1hdGVyaWFsIiwiTWVzaEJhc2ljTWF0ZXJpYWwiLCJtYXAiLCJkZXB0aFRlc3QiLCJkZXB0aFdyaXRlIiwibWVzaCIsIk1lc2giLCJhZGQiLCJvYmplY3QiLCJyZW1vdmUiLCJQZXJzcGVjdGl2ZUNhbWVyYSIsImlubmVyV2lkdGgiLCJpbm5lckhlaWdodCIsImNyZWF0ZSIsImdsQ2FudmFzIiwiZGltZW5zaW9ucyIsInJlbmRlciIsInJlbmRlcmVyIiwicmVhbGl0eSIsInZpcnR1YWwiLCJtb2RlbCIsIldlYkdMUmVuZGVyZXIiLCJjYW52YXMiLCJzZXRTaXplIiwid2lkdGgiLCJoZWlnaHQiLCJhdXRvQ2xlYXIiLCJsaWdodCIsIlNwb3RMaWdodCIsInBvc2l0aW9uIiwic2V0IiwibG9va0F0IiwiVmVjdG9yMyIsInZpZGVvIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImdldE1lZGlhQ2FwdHVyZSIsInQiLCJvbnN1Y2Nlc3MiLCJvbmVycm9yIiwicmVzdWx0IiwidW5kZWZpbmVkIiwibmF2aWdhdG9yIiwiZ2V0VXNlck1lZGlhIiwid2Via2l0R2V0VXNlck1lZGlhIiwib25TdWNjZXNzIiwiY2IiLCJzdHJlYW0iLCJ2ZW5kb3JVUkwiLCJVUkwiLCJ3ZWJraXRVUkwiLCJzcmMiLCJjcmVhdGVPYmplY3RVUkwiLCJwbGF5Iiwib25FcnJvciIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJ3YWl0Q2FtZXJhIiwiY2FsbGJhY2siLCJhdWRpbyIsImdldERpbWVuc2lvbnMiLCJjb3B5VG9Db250ZXh0IiwiY29udGV4dCIsImRyYXdJbWFnZSIsIkpTQVJSYXN0ZXIiLCJOeUFSUmdiUmFzdGVyX0NhbnZhczJEIiwiSlNBUlBhcmFtZXRlcnMiLCJGTEFSUGFyYW0iLCJKU0FSRGV0ZWN0b3IiLCJGTEFSTXVsdGlJZE1hcmtlckRldGVjdG9yIiwic2V0Q29udGludWVNb2RlIiwiZ2V0TWFya2VyTnVtYmVyIiwiaWR4IiwiZGF0YSIsImdldElkTWFya2VyRGF0YSIsInBhY2tldExlbmd0aCIsImkiLCJnZXRQYWNrZXREYXRhIiwiZ2V0VHJhbnNmb3JtTWF0cml4IiwibWF0IiwiTnlBUlRyYW5zTWF0UmVzdWx0IiwiY20iLCJGbG9hdDMyQXJyYXkiLCJtMDAiLCJtMTAiLCJtMjAiLCJtMDEiLCJtMTEiLCJtMjEiLCJtMDIiLCJtMTIiLCJtMjIiLCJtMDMiLCJtMTMiLCJtMjMiLCJnZXRDYW1lcmFNYXRyaXgiLCJ6TmVhciIsInpGYXIiLCJjb3B5Q2FtZXJhTWF0cml4IiwicGVyc2lzdFRpbWUiLCJuZXdNYXJrZXIiLCJpZCIsIm1hdHJpeCIsImFnZSIsIm1hcmtlcnMiLCJkZXRlY3QiLCJvbkNyZWF0ZSIsIm9uVXBkYXRlIiwib25EZXN0cm95IiwibWFya2VyQ291bnQiLCJkZXRlY3RNYXJrZXJMaXRlIiwiaW5kZXgiLCJtYXJrZXIiLCJBUkRldGVjdG9yIiwiQVIzRCIsIkFSTWFya2VyIiwiZGV0ZWN0b3IiLCJ2aWV3IiwiY3JlYXRlRWxlbWVudCIsImNhbWVyYURpbWVuc2lvbnMiLCJnZXRDb250ZXh0IiwiY2hhbmdlZCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsIkFST2JqZWN0Iiwib2JqZWN0cyIsMTYsImNvbG9yIiwzMiw2NCwicm90YXRpb24iLCJ4IiwieSIsImNyZWF0ZU1hcmtlck1lc2giLCJCb3hHZW9tZXRyeSIsImN1YmUiLCJ6IiwiY3JlYXRlTWFya2VyT2JqZWN0IiwicGFyYW1zIiwibW9kZWxNZXNoIl0sIm1hcHBpbmdzIjoiQUFBQSxHQUFBQSxLQUFBQyxRQUFBQyxPQUFBLGNBQUEsU0NBQUQsU0FBQUMsT0FBQSxjQUNBQyxLQUFBLGlCQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLE1BQUEsV0FDQUMsT0FBQUMsU0FBQUQsT0FBQUMsUUFBQUMsUUFBQUMsV0FHQUYsUUFBQUMsUUFBQUMsU0FBQUMsMEJBQUEsR0FLQUgsUUFBQUMsUUFBQUMsU0FBQUUsZUFBQSxJQUVBTCxPQUFBTSxXQUNBQSxVQUFBQyxvQkNk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ci5tb2R1bGUoJ2FyLXRvb2xraXQnLCBbJ2lvbmljJ10pXG5cblxuICAgICAgICAgIFxuXHRcdCIsImFuZ3VsYXIubW9kdWxlKCdhci10b29sa2l0JylcclxuLnJ1bihmdW5jdGlvbigkaW9uaWNQbGF0Zm9ybSkge1xyXG4gICRpb25pY1BsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkge1xyXG4gICAgaWYod2luZG93LmNvcmRvdmEgJiYgd2luZG93LmNvcmRvdmEucGx1Z2lucy5LZXlib2FyZCkge1xyXG4gICAgICAvLyBIaWRlIHRoZSBhY2Nlc3NvcnkgYmFyIGJ5IGRlZmF1bHQgKHJlbW92ZSB0aGlzIHRvIHNob3cgdGhlIGFjY2Vzc29yeSBiYXIgYWJvdmUgdGhlIGtleWJvYXJkXHJcbiAgICAgIC8vIGZvciBmb3JtIGlucHV0cylcclxuICAgICAgY29yZG92YS5wbHVnaW5zLktleWJvYXJkLmhpZGVLZXlib2FyZEFjY2Vzc29yeUJhcih0cnVlKTtcclxuXHJcbiAgICAgIC8vIERvbid0IHJlbW92ZSB0aGlzIGxpbmUgdW5sZXNzIHlvdSBrbm93IHdoYXQgeW91IGFyZSBkb2luZy4gSXQgc3RvcHMgdGhlIHZpZXdwb3J0XHJcbiAgICAgIC8vIGZyb20gc25hcHBpbmcgd2hlbiB0ZXh0IGlucHV0cyBhcmUgZm9jdXNlZC4gSW9uaWMgaGFuZGxlcyB0aGlzIGludGVybmFsbHkgZm9yXHJcbiAgICAgIC8vIGEgbXVjaCBuaWNlciBrZXlib2FyZCBleHBlcmllbmNlLlxyXG4gICAgICBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQuZGlzYWJsZVNjcm9sbCh0cnVlKTtcclxuICAgIH1cclxuICAgIGlmKHdpbmRvdy5TdGF0dXNCYXIpIHtcclxuICAgICAgU3RhdHVzQmFyLnN0eWxlRGVmYXVsdCgpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgfSk7XHJcbiAgICBcclxuICAgIFxyXG59KSIsImFuZ3VsYXIubW9kdWxlKCdhci10b29sa2l0JylcclxuICAgIC5kaXJlY3RpdmUoJ2FyVmlldycsIGZ1bmN0aW9uKEFSVXRpbHMsIEFSQ2FtZXJhLCBBUiwgJGlvbmljUGxhdGZvcm0pIHtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHJlc3RyaWN0OiAnQScsXHJcbiAgICAgICAgbGluazpmdW5jdGlvbihzY29wZSwgdEVsZW1lbnQsIGF0dHJzKXtcclxuICAgICAgICAgICAgdmFyIGVsZW09dEVsZW1lbnRbMF07XHJcbiAgICAgICAgICAgICRpb25pY1BsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgQVJVdGlscy5zaXplKGVsZW0pO1xyXG4gICAgICAgICAgICAgICAgQVJVdGlscy4gc2V0VmlkZW9TaXplKCk7XHJcbiAgICAgICAgICAgICAgICBBUkNhbWVyYS53YWl0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgQVIuaW5pdChlbGVtKTtcclxuICAgICAgICAgICAgICAgICAgICBBUi50aWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxufSk7IiwiYW5ndWxhci5tb2R1bGUoJ2FyLXRvb2xraXQnKVxyXG4gICAgLmZhY3RvcnkoJ0FSM0QnLCBmdW5jdGlvbigpIHtcclxuXHJcblxyXG4gICAgdmFyIFJlYWxpdHk9ZnVuY3Rpb24oc291cmNlQ2FudmFzKXtcclxuXHJcbiAgICAgICAgdmFyIGNhbWVyYT0gbmV3IFRIUkVFLkNhbWVyYSgpO1xyXG4gICAgICAgIHZhciBzY2VuZT0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcblxyXG4gICAgICAgIHZhciBnZW9tZXRyeT0gbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoMiwyLDApO1xyXG4gICAgICAgIHZhciB0ZXh0dXJlPW5ldyBUSFJFRS5UZXh0dXJlKHNvdXJjZUNhbnZhcyk7XHJcbiAgICAgICAgdGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSBmYWxzZTtcclxuICAgICAgICB0ZXh0dXJlLm1pbkZpbHRlciA9IFRIUkVFLk5lYXJlc3RGaWx0ZXI7XHJcbiAgICAgICAgdGV4dHVyZS5tYWdGaWx0ZXIgPSBUSFJFRS5OZWFyZXN0RmlsdGVyO1xyXG4gICAgICAgIHRleHR1cmUud3JhcFMgPSB0ZXh0dXJlLndyYXBUID1USFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nO1xyXG5cclxuXHJcblxyXG5cclxuICAgICAgICB2YXIgbWF0ZXJpYWw9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7XHJcbiAgICAgICAgICAgIG1hcDp0ZXh0dXJlLFxyXG4gICAgICAgICAgICBkZXB0aFRlc3Q6ZmFsc2UsXHJcbiAgICAgICAgICAgIGRlcHRoV3JpdGU6ZmFsc2VcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdmFyIG1lc2g9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCBtYXRlcmlhbCk7XHJcbiAgICAgICAgc2NlbmUuYWRkKG1lc2gpO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiB1cGRhdGUoKXtcclxuICAgICAgICAgICAgdGV4dHVyZS5uZWVkc1VwZGF0ZT10cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY2FtZXJhOiBjYW1lcmEsXHJcbiAgICAgICAgICAgIHNjZW5lOiBzY2VuZSxcclxuICAgICAgICAgICAgdXBkYXRlOiB1cGRhdGUsIFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIFNjZW5lID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcbiAgICAgICAgdmFyIGNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSggNzUsIHdpbmRvdy5pbm5lcldpZHRoL3dpbmRvdy5pbm5lckhlaWdodCwgMC4xLCAxMDAwICk7XHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGFkZChvYmplY3QpIHtcclxuXHJcbiAgICAgICAgICAgIHNjZW5lLmFkZChvYmplY3QpO1xyXG5cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiByZW1vdmUob2JqZWN0KSB7XHJcbiAgICAgICAgICAgIHNjZW5lLnJlbW92ZShvYmplY3QpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgc2NlbmU6c2NlbmUsXHJcbiAgICAgICAgICAgIGNhbWVyYTpjYW1lcmEsXHJcbiAgICAgICAgICAgIGFkZDphZGQsXHJcbiAgICAgICAgICAgIHJlbW92ZTpyZW1vdmVcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHZhciBjcmVhdGU9ZnVuY3Rpb24oZ2xDYW52YXMsIGRpbWVuc2lvbnMsIHNvdXJjZUNhbnZhcyl7XHJcblxyXG4gICAgICAgIHZhciByZW5kZXJlcj1uZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7Y2FudmFzOmdsQ2FudmFzfSk7XHJcbiAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZShkaW1lbnNpb25zLndpZHRoLCBkaW1lbnNpb25zLmhlaWdodCk7XHJcbiAgICAgICAgcmVuZGVyZXIuYXV0b0NsZWFyPWZhbHNlO1xyXG5cclxuICAgICAgICB2YXIgcmVhbGl0eT0gbmV3IFJlYWxpdHkoc291cmNlQ2FudmFzKTtcclxuICAgICAgICB2YXIgdmlydHVhbD0gbmV3IFNjZW5lKCk7XHJcblxyXG4gICAgICAgIHZhciBsaWdodD1uZXcgVEhSRUUuU3BvdExpZ2h0KDB4ZmZmZmZmKTtcclxuICAgICAgICBsaWdodC5wb3NpdGlvbi5zZXQoMCwwLDkwMDApO1xyXG4gICAgICAgIGxpZ2h0Lmxvb2tBdChuZXcgVEhSRUUuVmVjdG9yMygwLDAsMCkpO1xyXG4gICAgICAgIHZpcnR1YWwuc2NlbmUuYWRkKGxpZ2h0KTtcclxuXHJcblxyXG5cclxuICAgICAgICAvKnZhciBnZW9tZXRyeSA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSggMSwgMSwgMSApO1xyXG4gICAgICAgIHZhciBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogMHgwMGZmMDAgfSApO1xyXG4gICAgICAgIHZhciBjdWJlID0gbmV3IFRIUkVFLk1lc2goIGdlb21ldHJ5LCBtYXRlcmlhbCApO1xyXG4gICAgICAgIHZpcnR1YWwuYWRkKCBjdWJlICk7XHJcblxyXG4gICAgICAgIGN1YmUucG9zaXRpb24uej0tNTsqL1xyXG5cclxuXHJcblxyXG5cclxuICAgICAgICBmdW5jdGlvbiByZW5kZXIoKXtcclxuICAgICAgICAgICAgcmVuZGVyZXIucmVuZGVyKHJlYWxpdHkuc2NlbmUsIHJlYWxpdHkuY2FtZXJhKTtcclxuXHJcblxyXG4gICAgICAgICAgIC8qIGN1YmUucm90YXRpb24ueCArPSAwLjE7XHJcbiAgICAgICAgICAgIGN1YmUucm90YXRpb24ueSArPSAwLjE7Ki9cclxuXHJcblxyXG4gICAgICAgICAgICByZW5kZXJlci5yZW5kZXIodmlydHVhbC5zY2VuZSwgdmlydHVhbC5jYW1lcmEpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSgpe1xyXG4gICAgICAgICAgICAgcmVhbGl0eS51cGRhdGUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGFkZChvYmplY3Qpe1xyXG4gICAgICAgICAgICAgIHZpcnR1YWwuYWRkKG9iamVjdC5tb2RlbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgXHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHJlbW92ZShvYmplY3Qpe1xyXG4gICAgICAgICAgICAgdmlydHVhbC5yZW1vdmUob2JqZWN0Lm1vZGVsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGFkZDogYWRkLFxyXG4gICAgICAgICAgICByZW1vdmU6IHJlbW92ZSxcclxuICAgICAgICAgICAgdXBkYXRlOiB1cGRhdGUsXHJcbiAgICAgICAgICAgIHJlbmRlcjogcmVuZGVyLFxyXG4gICAgICAgICAgICBnbENhbnZhczogZ2xDYW52YXNcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgY3JlYXRlOmNyZWF0ZVxyXG4gICAgfVxyXG5cclxufSk7IiwiYW5ndWxhci5tb2R1bGUoJ2FyLXRvb2xraXQnKVxyXG4gICAgLmZhY3RvcnkoJ0FSQ2FtZXJhJywgZnVuY3Rpb24oIEFSVXRpbHMsICRpb25pY1BsYXRmb3JtKSB7XHJcblxyXG4gICAgdmFyIHZpZGVvPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmlkZW8nKTtcclxuIFxyXG4gICAgdmFyIGdldE1lZGlhQ2FwdHVyZSA9IGZ1bmN0aW9uKHQsIG9uc3VjY2Vzcywgb25lcnJvcikge1xyXG4gICAgICAgIHZhciByZXN1bHQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgaWYgKG5hdmlnYXRvci5nZXRVc2VyTWVkaWEpIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gbmF2aWdhdG9yLmdldFVzZXJNZWRpYSh0LCBvbnN1Y2Nlc3MsIG9uZXJyb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSkge1xyXG4gICAgICAgICAgICByZXN1bHQgPSBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKHQsIG9uc3VjY2Vzcywgb25lcnJvcik7XHJcbiAgICAgICAgfSBcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgb25TdWNjZXNzPWZ1bmN0aW9uKGNiKXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oc3RyZWFtKXtcclxuICAgICAgICAgICAgdmFyIHZlbmRvclVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTDtcclxuICAgICAgICAgICAgdmlkZW8uc3JjID0gdmVuZG9yVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pO1xyXG4gICAgICAgICAgICB2aWRlby5wbGF5KCk7XHJcbiAgICAgICAgICAgIGNiKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuICAgIHZhciBvbkVycm9yPWZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJBbiBlcnJvciBvY2N1cmVkISBcIiArIGVycik7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHZhciB3YWl0Q2FtZXJhPWZ1bmN0aW9uKGNhbGxiYWNrKXtcclxuXHJcbiAgICAgICAgZ2V0TWVkaWFDYXB0dXJlKHt2aWRlbzogdHJ1ZSxhdWRpbzogZmFsc2V9LCBvblN1Y2Nlc3MoY2FsbGJhY2spLCBvbkVycm9yKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGdldERpbWVuc2lvbnMgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3aWR0aDp2aWRlby53aWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OnZpZGVvLmhlaWdodFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB2YXIgY29weVRvQ29udGV4dD1mdW5jdGlvbihjb250ZXh0KXtcclxuICAgICAgICBjb250ZXh0LmRyYXdJbWFnZSh2aWRlbywgMCwwKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHdhaXQ6d2FpdENhbWVyYSxcclxuICAgICAgICBjb3B5VG9Db250ZXh0OmNvcHlUb0NvbnRleHQsXHJcbiAgICAgICAgZ2V0RGltZW5zaW9uczpnZXREaW1lbnNpb25zXHJcbiAgICB9XHJcblxyXG59KTsiLCJhbmd1bGFyLm1vZHVsZSgnYXItdG9vbGtpdCcpXHJcbiAgICAuZmFjdG9yeSgnQVJEZXRlY3RvcicsIGZ1bmN0aW9uKCkge1xyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZShzb3VyY2VDYW52YXMpe1xyXG4gICAgICAgdmFyIEpTQVJSYXN0ZXIgPSBuZXcgTnlBUlJnYlJhc3Rlcl9DYW52YXMyRChzb3VyY2VDYW52YXMpO1xyXG4gICAgICAgIHZhciBKU0FSUGFyYW1ldGVycyA9IG5ldyBGTEFSUGFyYW0oc291cmNlQ2FudmFzLndpZHRoLCBzb3VyY2VDYW52YXMuaGVpZ2h0KTtcclxuICAgICAgICB2YXIgSlNBUkRldGVjdG9yID0gbmV3IEZMQVJNdWx0aUlkTWFya2VyRGV0ZWN0b3IoSlNBUlBhcmFtZXRlcnMsIDEyMCk7XHJcbiAgICAgICAgSlNBUkRldGVjdG9yLnNldENvbnRpbnVlTW9kZSh0cnVlKTtcclxuXHJcbiAgICAgICAgdmFyIGdldE1hcmtlck51bWJlciA9IGZ1bmN0aW9uKGlkeCkge1xyXG4gICAgICAgICAgICB2YXIgZGF0YSA9IEpTQVJEZXRlY3Rvci5nZXRJZE1hcmtlckRhdGEoaWR4KTtcclxuICAgICAgICAgICAgaWYgKGRhdGEucGFja2V0TGVuZ3RoID4gNCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIHJlc3VsdD0wO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEucGFja2V0TGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSAocmVzdWx0IDw8IDgpIHwgZGF0YS5nZXRQYWNrZXREYXRhKGkpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmFyIGdldFRyYW5zZm9ybU1hdHJpeCA9IGZ1bmN0aW9uKGlkeCkge1xyXG4gICAgICAgICAgICB2YXIgbWF0ID0gbmV3IE55QVJUcmFuc01hdFJlc3VsdCgpO1xyXG4gICAgICAgICAgICBKU0FSRGV0ZWN0b3IuZ2V0VHJhbnNmb3JtTWF0cml4KGlkeCwgbWF0KTtcclxuXHJcbiAgICAgICAgICAgIHZhciBjbSA9IG5ldyBGbG9hdDMyQXJyYXkoMTYpO1xyXG4gICAgICAgICAgICBjbVswXSA9IG1hdC5tMDA7XHJcbiAgICAgICAgICAgIGNtWzFdID0gLW1hdC5tMTA7XHJcbiAgICAgICAgICAgIGNtWzJdID0gbWF0Lm0yMDtcclxuICAgICAgICAgICAgY21bM10gPSAwO1xyXG4gICAgICAgICAgICBjbVs0XSA9IG1hdC5tMDE7XHJcbiAgICAgICAgICAgIGNtWzVdID0gLW1hdC5tMTE7XHJcbiAgICAgICAgICAgIGNtWzZdID0gbWF0Lm0yMTtcclxuICAgICAgICAgICAgY21bN10gPSAwO1xyXG4gICAgICAgICAgICBjbVs4XSA9IC1tYXQubTAyO1xyXG4gICAgICAgICAgICBjbVs5XSA9IG1hdC5tMTI7XHJcbiAgICAgICAgICAgIGNtWzEwXSA9IC1tYXQubTIyO1xyXG4gICAgICAgICAgICBjbVsxMV0gPSAwO1xyXG4gICAgICAgICAgICBjbVsxMl0gPSBtYXQubTAzO1xyXG4gICAgICAgICAgICBjbVsxM10gPSAtbWF0Lm0xMztcclxuICAgICAgICAgICAgY21bMTRdID0gbWF0Lm0yMztcclxuICAgICAgICAgICAgY21bMTVdID0gMTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBjbTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHZhciBnZXRDYW1lcmFNYXRyaXggPSBmdW5jdGlvbih6TmVhciwgekZhcikge1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEZsb2F0MzJBcnJheSgxNik7XHJcbiAgICAgICAgICAgIEpTQVJQYXJhbWV0ZXJzLmNvcHlDYW1lcmFNYXRyaXgocmVzdWx0LCB6TmVhciwgekZhcik7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgcGVyc2lzdFRpbWUgPSAxO1xyXG4gICAgICAgIHZhciBuZXdNYXJrZXIgPSBmdW5jdGlvbihpZCwgbWF0cml4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgICAgICBtYXRyaXg6IG1hdHJpeCxcclxuICAgICAgICAgICAgICAgIGFnZTogcGVyc2lzdFRpbWUsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHZhciBtYXJrZXJzID0ge307XHJcbiAgICAgICAgdmFyIGRldGVjdCA9IGZ1bmN0aW9uKCBvbkNyZWF0ZSwgb25VcGRhdGUsIG9uRGVzdHJveSApIHtcclxuICAgICAgICAgICAgdmFyIG1hcmtlckNvdW50ID0gSlNBUkRldGVjdG9yLmRldGVjdE1hcmtlckxpdGUoSlNBUlJhc3RlciwgNzApOyBcclxuICAgICAgICAgICAgZm9yKCB2YXIgaW5kZXggPSAwOyBpbmRleCA8IG1hcmtlckNvdW50OyBpbmRleCsrICkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGlkID0gZ2V0TWFya2VyTnVtYmVyKGluZGV4KTtcclxuICAgICAgICAgICAgICAgIHZhciBtYXJrZXIgPSBtYXJrZXJzW2lkXTtcclxuICAgICAgICAgICAgICAgIGlmKCBtYXJrZXIgPT09IHVuZGVmaW5lZCApIHtcclxuICAgICAgICAgICAgICAgICAgICBtYXJrZXIgPSBuZXdNYXJrZXIoaWQsIGdldFRyYW5zZm9ybU1hdHJpeChpbmRleCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1hcmtlcnNbaWRdID0gbWFya2VyO1xyXG4gICAgICAgICAgICAgICAgICAgIG9uQ3JlYXRlKCBtYXJrZXIgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG1hcmtlci5tYXRyaXggPSBnZXRUcmFuc2Zvcm1NYXRyaXgoaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1hcmtlci5hZ2UgPSBwZXJzaXN0VGltZTtcclxuICAgICAgICAgICAgICAgICAgICBvblVwZGF0ZSggbWFya2VyICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciggdmFyIGlkIGluIG1hcmtlcnMgKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbWFya2Vyc1tpZF07XHJcbiAgICAgICAgICAgICAgICBpZiggbWFya2VyICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKCBtYXJrZXIuYWdlLS0gPT0gMCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb25EZXN0cm95KCBtYXJrZXIgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1hcmtlcnNbaWRdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcblxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgZGV0ZWN0OiBkZXRlY3QsXHJcbiAgICAgICAgICAgIGdldENhbWVyYU1hdHJpeDogZ2V0Q2FtZXJhTWF0cml4XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGNyZWF0ZTpjcmVhdGVcclxuICAgIH1cclxuXHJcbn0pOyIsImFuZ3VsYXIubW9kdWxlKCdhci10b29sa2l0JylcclxuICAgIC5mYWN0b3J5KCdBUicsIGZ1bmN0aW9uKEFSQ2FtZXJhLCBBUkRldGVjdG9yLCBBUjNELCBBUk1hcmtlcikge1xyXG5cclxuICAgIHZhciBjYW52YXMsIGNvbnRleHQsIGRldGVjdG9yLCB2aWV3O1xyXG4gICAgdmFyIGluaXQ9ZnVuY3Rpb24oZ2xDYW52YXMpe1xyXG5cclxuICAgICAgICBjYW52YXM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcclxuICAgICAgICB2YXIgY2FtZXJhRGltZW5zaW9ucz1BUkNhbWVyYS5nZXREaW1lbnNpb25zKCk7XHJcbiAgXHJcbiAgICAgICAgY2FudmFzLndpZHRoID0gY2FtZXJhRGltZW5zaW9ucy53aWR0aDtcclxuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FtZXJhRGltZW5zaW9ucy5oZWlnaHQ7XHJcblxyXG4gICAgICAgIGNvbnRleHQ9Y2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcclxuXHJcbiAgICAgICAgZGV0ZWN0b3I9QVJEZXRlY3Rvci5jcmVhdGUoY2FudmFzKTtcclxuXHJcbiAgICAgICAgdmlldz1BUjNELmNyZWF0ZShnbENhbnZhcywgY2FtZXJhRGltZW5zaW9ucywgY2FudmFzKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhkZXRlY3Rvci5nZXRDYW1lcmFNYXRyaXgoMTAsMTAwMCkpXHJcblxyXG4gICBcclxuXHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHRpY2s9ZnVuY3Rpb24oKXtcclxuICAgICAgICBBUkNhbWVyYS5jb3B5VG9Db250ZXh0KGNvbnRleHQpO1xyXG4gICAgICAgIGNhbnZhcy5jaGFuZ2VkPXRydWU7XHJcblxyXG4gICAgICAgIGRldGVjdG9yLmRldGVjdChBUk1hcmtlci5vbkNyZWF0ZSh2aWV3KSwgQVJNYXJrZXIub25VcGRhdGUodmlldyksIEFSTWFya2VyLm9uRGVzdHJveSh2aWV3KSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmlldy51cGRhdGUoKTtcclxuICAgICAgICB2aWV3LnJlbmRlcigpO1xyXG5cclxuXHJcbiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGluaXQ6aW5pdCxcclxuICAgICAgICB0aWNrOnRpY2tcclxuICAgIH1cclxuXHJcbn0pOyIsImFuZ3VsYXIubW9kdWxlKCdhci10b29sa2l0JylcclxuICAgIC5mYWN0b3J5KCdBUk1hcmtlcicsIGZ1bmN0aW9uKEFST2JqZWN0KSB7XHJcblxyXG4gICAgdmFyIG9iamVjdHM9e1xyXG4gICAgICAgIDE2OiBBUk9iamVjdC5jcmVhdGUoe2NvbG9yOjB4Q0MwMDAwfSksXHJcbiAgICAgICAgMzI6IEFST2JqZWN0LmNyZWF0ZSh7Y29sb3I6MHgwMENDMDB9KSxcclxuICAgICAgICA2NDogQVJPYmplY3QuY3JlYXRlKHtjb2xvcjoweDAwMDBDQ30pXHJcbiAgICB9XHJcblxyXG5cclxuICAgIHZhciBvbkNyZWF0ZT1mdW5jdGlvbih2aWV3KXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24obWFya2VyKXtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJDcmVhdGVkXCIpXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1hcmtlci5pZClcclxuICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBvYmplY3Q9b2JqZWN0c1ttYXJrZXIuaWRdO1xyXG4gICAgICAgICAgICAvL29iamVjdC50cmFuc2Zvcm0obWFya2VyLm1hdHJpeCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG9iamVjdClcclxuICAgICAgICAgICAgdmFyIG1vZGVsPW9iamVjdC5tb2RlbDtcclxuICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi54ICs9IDAuMTtcclxuICAgICAgICAgICAgbW9kZWwucm90YXRpb24ueSArPSAwLjE7XHJcbiAgICAgICAgICAgIHZpZXcuYWRkKG9iamVjdCk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgdmFyIG9uVXBkYXRlPWZ1bmN0aW9uKHZpZXcpe1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbihtYXJrZXIpe1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidXBkYXRlXCIpXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1hcmtlci5pZClcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBvYmplY3Q9b2JqZWN0c1ttYXJrZXIuaWRdO1xyXG4gICAgICAgICAgICAvL29iamVjdC50cmFuc2Zvcm0obWFya2VyLm1hdHJpeCk7XHJcbiAgICAgICAgICAgICB2YXIgbW9kZWw9b2JqZWN0Lm1vZGVsO1xyXG4gICAgICAgICAgIG1vZGVsLnJvdGF0aW9uLnggKz0gMC4xO1xyXG4gICAgICAgICAgICBtb2RlbC5yb3RhdGlvbi55ICs9IDAuMTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIG9uRGVzdHJveT1mdW5jdGlvbih2aWV3KXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24obWFya2VyKXtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInJlbW92ZVwiKVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhtYXJrZXIuaWQpXHJcbiAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgb2JqZWN0PW9iamVjdHNbbWFya2VyLmlkXTtcclxuICAgICAgICAgICAgdmlldy5yZW1vdmUob2JqZWN0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIG9uQ3JlYXRlOm9uQ3JlYXRlLFxyXG4gICAgICAgIG9uVXBkYXRlOm9uVXBkYXRlLFxyXG4gICAgICAgIG9uRGVzdHJveTpvbkRlc3Ryb3lcclxuICAgIH1cclxufSk7IiwiYW5ndWxhci5tb2R1bGUoJ2FyLXRvb2xraXQnKVxyXG4gICAgLmZhY3RvcnkoJ0FST2JqZWN0JywgZnVuY3Rpb24oKSB7XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKCkge1xyXG4gICAgICAgIHZhciBtb2RlbCA9IG5ldyBUSFJFRS5PYmplY3QzRCgpO1xyXG4gICAgICAgXHJcbiAgICAgICAgcmV0dXJuIG1vZGVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZU1hcmtlck1lc2goY29sb3IpIHtcclxuICAgICAgICB2YXIgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkoIDEsIDEsIDEgKTtcclxuICAgICAgICB2YXIgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoIHsgY29sb3I6IGNvbG9yfSApO1xyXG4gICAgICAgIHZhciBjdWJlID0gbmV3IFRIUkVFLk1lc2goIGdlb21ldHJ5LCBtYXRlcmlhbCApO1xyXG4gICAgICAgIGN1YmUucG9zaXRpb24uej0tNTtcclxuICAgICAgICByZXR1cm4gY3ViZTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVNYXJrZXJPYmplY3QocGFyYW1zKSB7XHJcblxyXG4gICAgICAgIHZhciBtb2RlbE1lc2ggPSBjcmVhdGVNYXJrZXJNZXNoKHBhcmFtcy5jb2xvcik7XHJcbiAgICAgICAgICAgXHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgXHJcbiAgICAgICAgICAgIG1vZGVsOiBtb2RlbE1lc2hcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgY3JlYXRlOmNyZWF0ZU1hcmtlck9iamVjdFxyXG4gICAgfVxyXG59KTsiLCJhbmd1bGFyLm1vZHVsZSgnYXItdG9vbGtpdCcpXHJcbiAgICAuZmFjdG9yeSgnQVJVdGlscycsIGZ1bmN0aW9uKCRpb25pY1BsYXRmb3JtKSB7XHJcblxyXG4gICAgdmFyIHNpemU9ZnVuY3Rpb24oZWxlbSl7XHJcbiAgICAgICAgICAgIGVsZW0ud2lkdGg9d2luZG93LmlubmVyV2lkdGg7XHJcbiAgICAgICAgICAgIGVsZW0uaGVpZ2h0PXdpbmRvdy5pbm5lckhlaWdodDtcclxuICAgICAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHNpemU6c2l6ZSwgXHJcbiAgICAgICAgc2V0VmlkZW9TaXplOmZ1bmN0aW9uKCl7XHJcblxyXG4gICAgICAgICAgICBzaXplKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWRlbycpKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KTtcclxuIl19
